<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sesam Community</title>

  <!-- React JS -->
  <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- momentjs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <!-- Firebase -->
  <script defer src="/__/firebase/3.8.0/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <script defer src="/__/firebase/3.8.0/firebase-auth.js"></script>
  <script defer src="/__/firebase/3.8.0/firebase-database.js"></script>
  <script defer src="/__/firebase/3.8.0/firebase-messaging.js"></script>
  <script defer src="/__/firebase/3.8.0/firebase-storage.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
</head>
<body>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <h1 class="header center blue-text">Sesam Community</h1>
      <div class="row center">
        <h5 class="header col s12 light">Sesam extentions maintained by the community</h5>
      </div>
      <div class="row center">
        <a href="https://docs.sesam.io/extension-points.html" class="btn-large waves-effect waves-light blue">Extending Sesam</a>
        <a href="https://github.com/sesam-community/guidelines" class="btn-large waves-effect waves-light blue">Community Guidelines</a>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="section">
      <div id="app">
      </div>
    </div>
  </div>
  <footer class="page-footer blue">
    <div class="footer-copyright">
      <div class="container">
        Powered by <a class="blue-text text-lighten-3" href="https://firebase.google.com">Firebase</a> and <a class="blue-text text-lighten-3" href="https://sesam.io">Sesam</a>
      </div>
    </div>
  </footer>
</body>
</html>

<script type="text/babel">
  const rules = {
    'same-image-name-as-repo-name': {
      title: 'Correct image name',
      description: 'Docker image name should match the name of the Github repo',
      tag: 'dockerfile',
      error: true
    },
    'has-issue-tracker': {
      title: 'Issue tracker',
      description: 'Repository should have an issue tracker',
      tag: 'github'
    },
    'has-description-github': {
      title: 'Description',
      description: 'Repository should have a description',
      tag: 'github'
    },
    'has-topic-sesam-in-github': {
      title: 'Sesam topic',
      description: 'Every repository should be tagged with topic \'Sesam\'',
      tag: 'github'
    },
    'has-topic-sink-source-transform-or-misc-in-github': {
      title: 'Additional topic',
      description: 'Every repository should be tagget with one or more of source, sink, transform or misc',
      tag: 'github'
    },
    'is-in-travis': {
      title: 'Present',
      description: 'Repository must be activated in Travis',
      tag: 'travis',
      error: true
    },
    'has-docker-password-in-travis': {
      title: 'Docker password',
      description: 'Environment variable DOCKER_PASSWORD must be configured on the repository in Travis',
      tag: 'travis',
      error: true
    },
    'has-docker-username-in-travis': {
      title: 'Docker username',
      description: 'Environment variable DOCKER_USERNAME must be configured on the repository in Travis',
      tag: 'travis',
      error: true
    },
    'is-in-dockerhub': {
      title: 'Built',
      description: 'Build must be working in order for Travis to push to Dockerhub',
      tag: 'travis',
      error: true
    },
    'matching-description-in-dockerhub': {
      title: 'Description match',
      description: 'Description in Dockerhub should be the same as on Github',
      tag: 'dockerhub'
    },
    'matching-full-description-in-dockerhub': {
      title: 'Full description match',
      description: 'Full description in Dockerhub should be a link to the Github repository',
      tag: 'dockerhub'
    },
    'has-reference-to-image-name-in-readme': {
      title: 'Image name reference',
      description: 'Image name should be referenced in the example config section of the readme',
      tag: 'readme'
    },
    'has-travis-badge-in-readme': {
      title: 'Travis Badge',
      description: 'Readme should include a Travis badge to show that build is working',
      tag: 'readme'
    },
  };

  function Validator(props) {
    const tag = props.tag;
    const repo = props.repo;
    //console.log(props)
    if (repo.updated_at != null) {
      repo.updated_at = repo.updated_at.substring(0, 10)
    }
    if (repo.pull_count == null) {
      repo.pull_count = 0        
    }
    if (repo.total_count == null) {
      repo.total_count = 0
    }
    if (repo.forks == null) {
      repo.forks = 0
    }
    if (repo.updated_at == null) {
      repo.updated_at = "Not valid";
    }

    const add = (a, b) => a + b;

    const countViolations = (keyFilter) => Object.keys(repo)
      .filter(k => k in rules)
      .filter(k => rules[k].tag === tag)
      .filter(keyFilter)
      .map(k => repo[k] ? 0 : 1)
      .reduce(add, 0);
    const errors = countViolations(k => rules[k].error);
    const warnings = countViolations(k => !rules[k].error);
    const problems = Object.keys(repo)
      .filter(k => k in rules)
      .filter(k => rules[k].tag === tag)
      .filter(k => !repo[k])
      .map(k => rules[k].description);
    return (
      <i className="material-icons small" title={problems.join(". ")}>{ errors > 0 ? 'error' : warnings > 0 ? 'warning' : 'done'}</i>
    );
  }

  function RepoCard(props) {
    function add(a, b) {
      return a + b;
    }

    const example = {
      '_id': `my-${props.data.name}`,
      type: 'system:microservice',
      docker: {
        environment: {
        },
        image: `sesamcommunity/${props.data.name}`,
        port: 5000,
      }
    };

    const NoUpdate = "No date provided"

    return (
      <div className="card blue-grey darken-1">
        <div className="card-content white-text">
          <span className="card-title">{props.data.name}</span>
          {props.data.badge_url && <img src={props.data.badge_url} alt="travis-badge" />}
          <p>{props.data.description}</p>
          <p>Last update : {props.data.updated_at}</p>
          <p>Forks : {props.data.forks}</p>
          <p>Pulls : {props.data.pull_count}</p>
          <p>Config count : {props.data.total_count}</p>
          <details>
            <summary>Example config</summary>
            <pre>
              {JSON.stringify(example, null, 2)}
            </pre>
            <p>You might need to change the port and environment settings. {props.data.readme_url && 'Consult the README file for more information.'}</p>
          </details>
          {props.data.tags && <details>
            <summary>Available tags</summary>
            <ul id="myUL">
              {props.data.tags.map(t => (
                <li key={t.name}><b>{t.name}</b>: ({Math.round(t.size / 1e6)} Mb) - built { moment(t.last_updated).fromNow()}</li>
              ))}
            </ul>
          </details>}
        </div>
        <div className="card-action">
          {props.data.html_url && <a href={props.data.html_url}><Validator tag="github" repo={props.data}/> Github</a>}
          {props.data.travis_url && <a href={props.data.travis_url}><Validator tag="travis" repo={props.data}/> Travis</a>}
          {props.data.dockerhub_url && <a href={props.data.dockerhub_url}><Validator tag="dockerhub" repo={props.data}/> Dockerhub</a>}
          {props.data.readme_url && <a href={props.data.readme_url}><Validator tag="readme" repo={props.data}/> Readme</a>}
          {props.data.issues_url && <a href={props.data.issues_url}><Validator tag="issues" repo={props.data}/> Issues</a>}
        </div>
      </div>
    );
  }


  class Filter extends React.Component {
    constructor(props) {
      super(props);
      this.filterChanged = ev => {
        this.props.onFilterChanged(ev.target.value)
      }
    }

    render() {
      return (
        <div class="dropdown">
          <button  id="dropbtn" onclick={this.filterChanged} class="btn-large waves-effect waves-light blue">FILTER</button>
          <div id="myDropdown" class="dropdown-content">
            <a href="#update">Last Update</a>
            <a href="#forks">Forks</a>
            <a href="#pulls">Pulls</a>
            <a href="#config">Config Count</a>
          </div>
        </div>
      );
    }
  }


  class Search extends React.Component {
    constructor(props) {
      super(props);
      this.handleChanged = ev => {
        this.props.onSearchChanged(ev.target.value) 
      }
    }

    render() {
      return (
        <input type="text" id="myInput" onChange={this.handleChanged} placeholder="Search for repositories.."></input>
      );
    }
  }


  class App extends React.Component {
    constructor(props) {
      super(props);
      this.repos = {};
      this.handleSearchChanged = (value) => {
        this.setState({value: value});
      }
      this.handleFilterChanged = (value) => {
        this.setState({value: value});
      }
      this.state = { repos: this.repos, value: "" };
    }

    componentWillMount() {
      this.firebaseRef = firebase.database().ref('repos');
      this.firebaseRef.on("child_added", function (data) {
        this.repos[data.key] = data.val();
        this.setState({
          repos: this.repos
        });
      }.bind(this));
      this.firebaseRef.on("child_removed", function (data) {
        delete this.repos[data.key];
        this.setState({
          repos: this.repos
        });
      }.bind(this));
      this.firebaseRef.on("child_changed", function (data) {
        this.repos[data.key] = data.val();
        this.setState({
          repos: this.repos
        });
      }.bind(this));
      console.log(this.repos)
    }

    componentWillUnmount() {
      this.firebaseRef.off();
    }

    render() {
      const searchedRepoNames = Object.keys(this.state.repos).filter(name => {
        return name.startsWith(this.state.value);
      })
      const filteredRepos = Object.keys(this.state.repos).filter(pull_count => {
        return (pull_count).startsWith(this.state.value)
      })
      return (
        <div>
          <Filter onFilterChanged={this.handleFilterChanged}/>
          <Search onSearchChanged={this.handleSearchChanged} />
          {searchedRepoNames.map(name => (
            <RepoCard key={name} data={this.state.repos[name]} />
          ))}
        </div>
      );
    }  
  } 

  ReactDOM.render( <App />, document.getElementById('app'));
</script>


<style scoped>

#myInput {
  background-image: url('https://img.icons8.com/wired/64/000000/search.png'); /* Add a search icon to input */
  background-position: 8px 10px; /* Position the search icon */
  background-repeat: no-repeat; /* Do not repeat the icon image */
  width: 25%; /* Full-width */
  font-size: 16px; /* Increase font-size */
  padding: 12px 20px 12px 40px; /* Add some padding */
  margin-top: 12px;
  margin-bottom: 1px; /* Add some space below the input */
  text-align: center;
}

/* Dropdown Button */
.dropbtn {
  background-color: #3498DB;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
  cursor: pointer;
}

/* Dropdown button on hover & focus */
.dropbtn:hover, .dropbtn:focus {
  background-color: #2980B9;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd}

/* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
.show {display:block;}

</style>